<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Fishing Playable</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  overflow:hidden;
  background:#02253d;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  -webkit-user-select:none;
  user-select:none;
}
#gameRoot{
  position:relative;
  width:100%;
  height:100%;
  overflow:hidden;
  touch-action:none;
  background:linear-gradient(#78d2ff 0%,#0c395a 40%,#021624 100%);
}
#gameCanvas{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  display:block;
}
/* UI ROOT */
#uiRoot{
  position:absolute;
  inset:0;
  pointer-events:none;
  color:#fff;
  font-size:14px;
}

/* TOP BAR */
#topBar{
  position:absolute;
  top:1.5vh;
  left:0;
  right:0;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 4vw;
  pointer-events:none;
}
.counter{
  display:flex;
  align-items:center;
  background:rgba(0,0,0,0.4);
  border-radius:999px;
  padding:0.3em 0.8em;
  backdrop-filter:blur(4px);
}
.counter svg{
  width:18px;
  height:18px;
  margin-right:0.4em;
}
#coinCounter{pointer-events:auto;}
#fishCounter{display:none;pointer-events:auto;}
#fishBarOuter{
  width:24vw;
  max-width:140px;
  height:8px;
  background:rgba(255,255,255,0.15);
  border-radius:999px;
  margin-left:0.6em;
  overflow:hidden;
}
#fishBarInner{
  width:0%;
  height:100%;
  background:linear-gradient(90deg,#6cf5ff,#fff06c);
  border-radius:999px;
}

/* CENTER LABELS */
#centerLabel{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  text-align:center;
  pointer-events:none;
}
#rarityLabel{
  font-size:20px;
  font-weight:700;
  text-shadow:0 0 12px rgba(0,0,0,0.8);
  opacity:0;
  transition:opacity 0.25s;
}

/* GAUGE + PLAY */
#bottomUI{
  position:absolute;
  left:0;
  right:0;
  bottom:2vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:1.2vh;
  pointer-events:none;
}
#roundLabel{
  background:rgba(0,0,0,0.45);
  padding:0.2em 0.7em;
  border-radius:999px;
  font-size:12px;
}
#gaugeContainer{
  width:70vw;
  max-width:420px;
  height:48px;
  background:rgba(0,0,0,0.45);
  border-radius:999px;
  padding:7px 12px;
  box-sizing:border-box;
  display:flex;
  align-items:center;
  gap:10px;
  pointer-events:auto;
}
#gaugeTrack{
  position:relative;
  flex:1;
  height:8px;
  border-radius:999px;
  background:linear-gradient(90deg,#4be0ff,#fff06c,#ff6c8b);
  overflow:hidden;
}
#gaugePointer{
  position:absolute;
  top:50%;
  width:3px;
  height:18px;
  border-radius:999px;
  background:#fff;
  box-shadow:0 0 6px rgba(0,0,0,0.7);
  transform:translate(-50%,-50%);
}
#playButton{
  flex:0 0 auto;
  padding:0.4em 1em;
  border-radius:999px;
  background:#ffcc33;
  color:#000;
  font-weight:700;
  font-size:14px;
  box-shadow:0 4px 0 #b28700;
  cursor:pointer;
  border:none;
}
#playButton:active{
  transform:translateY(1px);
  box-shadow:0 3px 0 #b28700;
}

/* UPGRADES PANEL */
#upgradePanel{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:calc(2vh + 60px + 2.5vh);
  display:flex;
  gap:1.5vw;
  pointer-events:auto;
}
.upgradeBtn{
  min-width:36vw;
  max-width:210px;
  background:rgba(0,0,0,0.55);
  border-radius:12px;
  padding:0.6em 0.8em;
  display:flex;
  flex-direction:column;
  gap:2px;
  font-size:12px;
}
.upTitle{
  font-weight:600;
  font-size:12px;
}
.upRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.upValue{
  font-weight:700;
  color:#ffe065;
}
.upCost{
  font-size:11px;
  opacity:0.8;
}
.upgradeBtn.disabled{
  opacity:0.4;
}

/* TUTORIAL OVERLAY */
#tutorialOverlay{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:20vh;
  background:rgba(0,0,0,0.65);
  padding:0.7em 1.2em;
  border-radius:999px;
  font-size:13px;
  pointer-events:none;
  opacity:0;
  transition:opacity 0.25s;
}

/* SUMMARY PANEL */
#summaryPanel{
  position:absolute;
  left:50%;
  top:55%;
  transform:translate(-50%,-50%);
  width:80vw;
  max-width:360px;
  background:rgba(0,0,0,0.78);
  border-radius:16px;
  padding:1.1em 1em;
  box-sizing:border-box;
  text-align:center;
  display:none;
  pointer-events:auto;
}
#summaryTitle{
  font-weight:700;
  margin-bottom:0.4em;
}
#summaryBody{
  font-size:13px;
  margin-bottom:0.4em;
}
#summaryGain{
  font-size:18px;
  font-weight:700;
  color:#ffe065;
  margin-bottom:0.4em;
}
#summaryNextBtn{
  margin-top:0.4em;
  padding:0.45em 1em;
  border-radius:999px;
  background:#4be0ff;
  color:#001219;
  border:none;
  font-weight:700;
  cursor:pointer;
}

/* END CARD */
#endCard{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  background:linear-gradient(#3a8dff,#12204a);
  color:#fff;
  text-align:center;
  pointer-events:auto;
  display:none;
}
#endCard h1{
  font-size:26px;
  margin:0 0 0.4em;
}
#endCard p{
  margin:0.2em 0;
}
#ctaButton{
  margin-top:1.2em;
  padding:0.7em 1.7em;
  border-radius:999px;
  border:none;
  background:#ffe065;
  color:#002034;
  font-weight:800;
  font-size:16px;
  cursor:pointer;
  box-shadow:0 5px 0 #b38d00;
}
#ctaButton:active{
  transform:translateY(1px);
  box-shadow:0 4px 0 #b38d00;
}

/* CATCH POPUPS */
.catchPopup{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  font-size:14px;
  font-weight:700;
  color:#ffe065;
  text-shadow:0 0 8px rgba(0,0,0,0.9);
  opacity:0;
  pointer-events:none;
}

/* Utility */
.hidden{display:none;}
.fadeIn{opacity:1;}
.fadeOut{opacity:0;}
@media (orientation:landscape){
  #bottomUI{
    bottom:3vh;
  }
  #upgradePanel{
    bottom:calc(3vh + 64px + 3vh);
  }
}
</style>
</head>
<body>
<div id="gameRoot">
  <canvas id="gameCanvas"></canvas>
  <div id="uiRoot">
    <div id="topBar">
      <div id="coinCounter" class="counter">
        <svg viewBox="0 0 32 32">
          <circle cx="16" cy="16" r="14" fill="#ffd54a" stroke="#c79400" stroke-width="2"/>
          <circle cx="16" cy="16" r="8" fill="#ffe89a" stroke="#c79400" stroke-width="2"/>
        </svg>
        <div id="coinText">100</div>
      </div>
      <div id="fishCounter" class="counter">
        <svg viewBox="0 0 32 32">
          <path d="M4 16 L12 10 L24 10 L28 6 L28 26 L24 22 L12 22 Z" fill="#8cf5ff" stroke="#0b4e66" stroke-width="2"/>
        </svg>
        <div id="fishText">0/6</div>
        <div id="fishBarOuter"><div id="fishBarInner"></div></div>
      </div>
    </div>

    <div id="centerLabel">
      <div id="rarityLabel"></div>
    </div>

    <div id="tutorialOverlay">Drag left and right to move the hook and catch fish!</div>

    <div id="upgradePanel">
      <div id="upgradeMaxFish" class="upgradeBtn">
        <div class="upTitle">Net Capacity</div>
        <div class="upRow">
          <div class="upValue" id="fishCapValue">6 fish</div>
          <div class="upCost" id="fishCapCost">Next: 50</div>
        </div>
      </div>
      <div id="upgradeMaxDepth" class="upgradeBtn">
        <div class="upTitle">Max Depth</div>
        <div class="upRow">
          <div class="upValue" id="depthValue">5 m</div>
          <div class="upCost" id="depthCost">Next: 50</div>
        </div>
      </div>
    </div>

    <div id="bottomUI">
      <div id="roundLabel">Round 1 / 3</div>
      <div id="gaugeContainer">
        <div id="gaugeTrack">
          <div id="gaugePointer"></div>
        </div>
        <button id="playButton">CAST</button>
      </div>
    </div>

    <div id="summaryPanel">
      <div id="summaryTitle">Catch Summary</div>
      <div id="summaryBody">Nice haul!</div>
      <div id="summaryGain">+0</div>
      <button id="summaryNextBtn">Next Round</button>
    </div>

    <div id="endCard">
      <h1>Your Fishing Trip</h1>
      <p>Total coins earned: <span id="endCoins">0</span></p>
      <p>Upgrade your gear and catch even rarer fish in the full game.</p>
      <button id="ctaButton">Install Now</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three-js@79.0.0/three.min.js"></script>
<script>
(function(){
'use strict';

/* ---------- ENUMS & CONSTANTS ---------- */
var GameState = { LOADING:0, GAMEPLAY:1, ENDCARD:2 };
var GameplaySubState = {
  HUB:0,
  GAUGE_ACTIVE:1,
  DESCENT:2,
  AT_DEPTH_PAUSE:3,
  ASCENT:4,
  SURFACE_SUMMARY:5,
  ROUND_TRANSITION:6
};
var UpgradeType = { MAX_FISH:0, MAX_DEPTH:1 };
var MAX_ROUNDS = 3;

var rarityTexts = ["","Rare!","Amazing!","Legendary!"];
var fishTypes = [
  { id:0, name:"Small",  baseValue:5,  rarityIndex:0, depthMin:0,  depthMax:10, color:0x6cf5ff },
  { id:1, name:"Medium", baseValue:10, rarityIndex:1, depthMin:5,  depthMax:20, color:0x4aa4ff },
  { id:2, name:"Big",    baseValue:20, rarityIndex:2, depthMin:10, depthMax:30, color:0xd56cff },
  { id:3, name:"Deep",   baseValue:40, rarityIndex:3, depthMin:15, depthMax:40, color:0xffd35a }
];

var maxFishUpgradeSteps = [
  { value:6, cost:0 },
  { value:7, cost:50 },
  { value:8, cost:100 },
  { value:9, cost:200 },
  { value:10, cost:400 }
];

var maxDepthUpgradeSteps = [
  { value:5,  cost:0 },
  { value:10, cost:50 },
  { value:15, cost:75 },
  { value:20, cost:150 },
  { value:30, cost:300 }
];

function FishInstance(typeRef, mesh){
  this.type = typeRef;
  this.position = new THREE.Vector3();
  this.isCaught = false;
  this.attachedToHook = false;
  this.value = typeRef.baseValue;
  this.rarityIndex = typeRef.rarityIndex;
  this.mesh = mesh;
}

/* ---------- GLOBAL GAME DATA ---------- */
var gameData = {
  coins:100,
  roundIndex:0,
  maxFishIndex:0,
  maxDepthIndex:0,
  currentRoundCatch:[],
  totalEarned:0
};

var gaugeState = {
  active:false,
  t:0,
  speed:0.6,
  phase:0
};

var hookState = {
  depthTarget:0,
  depthCurrent:0,
  speedDown:8,
  speedUp:10,
  caughtFishCount:0,
  fishOnLine:[],
  maxFishThisRound:function(){
    return maxFishUpgradeSteps[gameData.maxFishIndex].value;
  }
};

var timers = {
  stateStartTime:0,
  atDepthDuration:0,
  summaryTimer:0,
  lastFrameTime:0,
  rarityLabelTimer:0
};

var inputState = {
  isDraggingHook:false,
  lastPointerX:0
};

var catchingEnabled = true;

/* ---------- THREE.JS SCENE ---------- */
var renderer, scene, camera;
var boatGroup, fishermanGroup, hookMesh, lineMesh;
var waterPlane;
var fishPool = [];
var tmpVec3 = new THREE.Vector3();

/* ---------- UI ELEMENTS ---------- */
var coinText = document.getElementById('coinText');
var fishText = document.getElementById('fishText');
var fishBarInner = document.getElementById('fishBarInner');
var coinCounterEl = document.getElementById('coinCounter');
var fishCounterEl = document.getElementById('fishCounter');
var gaugePointerEl = document.getElementById('gaugePointer');
var gaugeContainer = document.getElementById('gaugeContainer');
var playButton = document.getElementById('playButton');
var upgradeMaxFishBtn = document.getElementById('upgradeMaxFish');
var upgradeMaxDepthBtn = document.getElementById('upgradeMaxDepth');
var fishCapValueEl = document.getElementById('fishCapValue');
var fishCapCostEl = document.getElementById('fishCapCost');
var depthValueEl = document.getElementById('depthValue');
var depthCostEl = document.getElementById('depthCost');
var tutorialOverlay = document.getElementById('tutorialOverlay');
var rarityLabelEl = document.getElementById('rarityLabel');
var summaryPanel = document.getElementById('summaryPanel');
var summaryBodyEl = document.getElementById('summaryBody');
var summaryGainEl = document.getElementById('summaryGain');
var summaryNextBtn = document.getElementById('summaryNextBtn');
var roundLabel = document.getElementById('roundLabel');
var endCard = document.getElementById('endCard');
var endCoinsEl = document.getElementById('endCoins');

/* ---------- STATE ---------- */
var currentState = GameState.LOADING;
var gameplaySubState = GameplaySubState.HUB;

/* ---------- INITIALIZATION ---------- */
function init(){
  initRendererAndScene();
  initUI();
  bindEvents();
  window.addEventListener('resize', onResize);
  onResize();
  currentState = GameState.GAMEPLAY;
  enterHub();
  timers.lastFrameTime = performance.now();
  requestAnimationFrame(gameLoop);
}

function initRendererAndScene(){
  var canvas = document.getElementById('gameCanvas');
  renderer = new THREE.WebGLRenderer({canvas:canvas, antialias:true});
  renderer.setPixelRatio(window.devicePixelRatio || 1);
  renderer.setClearColor(0x021624,1);

  scene = new THREE.Scene();
  scene.fog = new THREE.FogExp2(0x021624,0.04);

  camera = new THREE.PerspectiveCamera(55, window.innerWidth/window.innerHeight, 0.1, 80);
  camera.position.set(0,-2,13);
  camera.lookAt(new THREE.Vector3(0,-5,0));

  var ambLight = new THREE.AmbientLight(0xa0c0ff,0.7);
  scene.add(ambLight);
  var dirLight = new THREE.DirectionalLight(0xffffff,0.8);
  dirLight.position.set(6,-10,12);
  scene.add(dirLight);

  // Water plane as background
  var waterGeo = new THREE.PlaneGeometry(40,60,1,1);
  var waterMat = new THREE.MeshLambertMaterial({color:0x0b355a, side:THREE.DoubleSide});
  waterPlane = new THREE.Mesh(waterGeo, waterMat);
  waterPlane.rotation.x = -Math.PI/2;
  waterPlane.position.set(0,-10,0);
  scene.add(waterPlane);

  createBoatAndFisherman();
  createHookAndLine();
  createFishPool();
}

function createBoatAndFisherman(){
  boatGroup = new THREE.Group();
  scene.add(boatGroup);

  var boatGeo = new THREE.BoxGeometry(5,0.8,2);
  var boatMat = new THREE.MeshLambertMaterial({color:0x5c3b22});
  var boatMesh = new THREE.Mesh(boatGeo, boatMat);
  boatMesh.position.y = 0;
  boatGroup.add(boatMesh);

  fishermanGroup = new THREE.Group();
  boatGroup.add(fishermanGroup);
  fishermanGroup.position.set(-0.8,0.8,0);

  var bodyGeo = new THREE.CylinderGeometry(0.3,0.3,1.2,8);
  var bodyMat = new THREE.MeshLambertMaterial({color:0x2878ff});
  var body = new THREE.Mesh(bodyGeo, bodyMat);
  body.position.y = 0.4;
  fishermanGroup.add(body);

  var headGeo = new THREE.SphereGeometry(0.3,12,12);
  var headMat = new THREE.MeshLambertMaterial({color:0xffddc0});
  var head = new THREE.Mesh(headGeo, headMat);
  head.position.y = 1.2;
  fishermanGroup.add(head);

  var hatGeo = new THREE.CylinderGeometry(0.32,0.32,0.18,8);
  var hatMat = new THREE.MeshLambertMaterial({color:0xffc247});
  var hat = new THREE.Mesh(hatGeo, hatMat);
  hat.position.y = 1.4;
  fishermanGroup.add(hat);
}

function createHookAndLine(){
  var lineGeo = new THREE.CylinderGeometry(0.03,0.03,10,6);
  var lineMat = new THREE.MeshLambertMaterial({color:0xffffff});
  lineMesh = new THREE.Mesh(lineGeo, lineMat);
  lineMesh.position.set(0.5,-5,0);
  scene.add(lineMesh);

  var hookGeo = new THREE.TorusGeometry(0.15,0.04,8,16,Math.PI*0.9);
  var hookMat = new THREE.MeshLambertMaterial({color:0xd5d5d5});
  hookMesh = new THREE.Mesh(hookGeo, hookMat);
  hookMesh.rotation.z = Math.PI/2;
  hookMesh.position.set(0.5,-5,0);
  scene.add(hookMesh);
}

function createFishPool(){
  var fishCount = 26;
  var bodyGeo = new THREE.SphereGeometry(0.25,10,10);
  var tailGeo = new THREE.ConeGeometry(0.16,0.4,8);
  for(var i=0;i<fishCount;i++){
    var type = fishTypes[i % fishTypes.length];
    var color = type.color;
    var bodyMat = new THREE.MeshLambertMaterial({color:color});
    var tailMat = new THREE.MeshLambertMaterial({color:color});

    var body = new THREE.Mesh(bodyGeo, bodyMat);
    var tail = new THREE.Mesh(tailGeo, tailMat);
    tail.rotation.z = Math.PI;
    tail.position.x = -0.35;

    var group = new THREE.Group();
    group.add(body);
    group.add(tail);

    var fish = new FishInstance(type, group);
    group.userData.fishInstance = fish;

    scene.add(group);
    fishPool.push(fish);
  }
  layoutFishField();
}

function layoutFishField(){
  var maxDepth = maxDepthUpgradeSteps[ maxDepthUpgradeSteps.length-1 ].value;
  for(var i=0;i<fishPool.length;i++){
    var fish = fishPool[i];
    fish.isCaught = false;
    fish.attachedToHook = false;
    var depth = fish.type.depthMin + Math.random()*(fish.type.depthMax - fish.type.depthMin);
    depth = Math.min(depth,maxDepth+5);
    var x = (Math.random()*2-1)*5.5;
    var y = -depth;
    var z = (Math.random()*2-1)*1.5;
    fish.position.set(x,y,z);
    fish.mesh.position.copy(fish.position);
    fish.mesh.visible = true;
  }
}

/* ---------- UI ---------- */
function initUI(){
  updateCoinDisplay(gameData.coins);
  updateUpgradeButtons();
  showCoinCounter();
  hideFishCounter();
  hideTutorial();
}

function updateCoinDisplay(v){
  coinText.textContent = v|0;
}

function showCoinCounter(){
  coinCounterEl.style.display = 'flex';
}
function hideCoinCounter(){
  coinCounterEl.style.display = 'none';
}
function showFishCounter(){
  fishCounterEl.style.display = 'flex';
}
function hideFishCounter(){
  fishCounterEl.style.display = 'none';
}

function setFishCounter(current,max){
  fishText.textContent = current + "/" + max;
  var pct = max>0 ? (current/max)*100 : 0;
  fishBarInner.style.width = pct + "%";
}

function updateGaugePointer(phase){
  gaugeState.phase = phase;
  var pct = phase*100;
  gaugePointerEl.style.left = pct + "%";
}

function showTutorial(){
  tutorialOverlay.style.opacity = '1';
}
function hideTutorial(){
  tutorialOverlay.style.opacity = '0';
}

function showRarityLabel(text){
  rarityLabelEl.textContent = text;
  rarityLabelEl.style.opacity = '1';
  timers.rarityLabelTimer = 0.7;
}

function hideRarityLabel(){
  rarityLabelEl.style.opacity = '0';
}

function updateUpgradeButtons(){
  var mfIdx = gameData.maxFishIndex;
  var mdIdx = gameData.maxDepthIndex;
  var mfData = maxFishUpgradeSteps[mfIdx];
  var mdData = maxDepthUpgradeSteps[mdIdx];

  fishCapValueEl.textContent = mfData.value + " fish";
  depthValueEl.textContent = mdData.value + " m";

  if(mfIdx < maxFishUpgradeSteps.length-1){
    var nextMF = maxFishUpgradeSteps[mfIdx+1];
    fishCapCostEl.textContent = "Next: " + nextMF.cost;
    var can = gameData.coins >= nextMF.cost;
    upgradeMaxFishBtn.classList.toggle('disabled', !can);
  }else{
    fishCapCostEl.textContent = "Maxed";
    upgradeMaxFishBtn.classList.add('disabled');
  }

  if(mdIdx < maxDepthUpgradeSteps.length-1){
    var nextMD = maxDepthUpgradeSteps[mdIdx+1];
    depthCostEl.textContent = "Next: " + nextMD.cost;
    var can2 = gameData.coins >= nextMD.cost;
    upgradeMaxDepthBtn.classList.toggle('disabled', !can2);
  }else{
    depthCostEl.textContent = "Maxed";
    upgradeMaxDepthBtn.classList.add('disabled');
  }

  roundLabel.textContent = "Round " + (gameData.roundIndex+1) + " / " + MAX_ROUNDS;
}

function showSummary(totalGain){
  summaryGainEl.textContent = "+" + totalGain;
  if(totalGain<=0){
    summaryBodyEl.textContent = "No fish this time. Try a deeper cast!";
  }else{
    summaryBodyEl.textContent = "Great catch! Your coins increased.";
  }
  summaryPanel.style.display = 'block';
}

function hideSummary(){
  summaryPanel.style.display = 'none';
}

function showEndCard(){
  endCoinsEl.textContent = gameData.totalEarned|0;
  endCard.style.display = 'flex';
}

/* ---------- INPUT ---------- */
function bindEvents(){
  playButton.addEventListener('click', function(ev){
    ev.stopPropagation();
    onPlayButtonPressed();
  });

  upgradeMaxFishBtn.addEventListener('click', function(ev){
    ev.stopPropagation();
    onUpgradeClick(UpgradeType.MAX_FISH);
  });

  upgradeMaxDepthBtn.addEventListener('click', function(ev){
    ev.stopPropagation();
    onUpgradeClick(UpgradeType.MAX_DEPTH);
  });

  summaryNextBtn.addEventListener('click', function(ev){
    ev.stopPropagation();
    if(gameData.roundIndex >= MAX_ROUNDS){
      enterEndcard();
    }else{
      hideSummary();
      enterHub();
    }
  });

  window.addEventListener('pointerdown', onPointerDown);
  window.addEventListener('pointermove', onPointerMove);
  window.addEventListener('pointerup', onPointerUp);
  window.addEventListener('pointercancel', onPointerUp);
}

function onPointerDown(ev){
  inputState.lastPointerX = ev.clientX;
  if(gameplaySubState === GameplaySubState.ASCENT){
    inputState.isDraggingHook = true;
  }
}
function onPointerMove(ev){
  if(!inputState.isDraggingHook) return;
  var dx = ev.clientX - inputState.lastPointerX;
  inputState.lastPointerX = ev.clientX;
  onHookDrag(dx);
}
function onPointerUp(){
  inputState.isDraggingHook = false;
}

function onHookDrag(deltaX){
  var worldDeltaX = deltaX * 0.02;
  moveHookHorizontally(worldDeltaX);
}

/* ---------- GAMEPLAY FLOW ---------- */
function onPlayButtonPressed(){
  if(currentState !== GameState.GAMEPLAY) return;
  if(gameplaySubState === GameplaySubState.HUB){
    gameplaySubState = GameplaySubState.GAUGE_ACTIVE;
    gaugeState.active = true;
  }else if(gameplaySubState === GameplaySubState.GAUGE_ACTIVE){
    onGaugeTap();
  }
}

function onGaugeTap(){
  if(gameplaySubState !== GameplaySubState.GAUGE_ACTIVE) return;
  gaugeState.active = false;
  var maxDepth = maxDepthUpgradeSteps[gameData.maxDepthIndex].value;
  var minDepth = Math.max(1,maxDepth-3);
  var depthRange = maxDepth - minDepth;
  var phase = gaugeState.phase;
  var selectedDepth = minDepth + depthRange*phase;
  startDescent(selectedDepth);
}

function onUpgradeClick(type){
  if(gameplaySubState !== GameplaySubState.HUB) return;
  if(type === UpgradeType.MAX_FISH){
    var idx = gameData.maxFishIndex;
    if(idx >= maxFishUpgradeSteps.length-1) return;
    var next = maxFishUpgradeSteps[idx+1];
    if(gameData.coins >= next.cost){
      gameData.coins -= next.cost;
      gameData.maxFishIndex++;
      updateCoinDisplay(gameData.coins);
      updateUpgradeButtons();
    }
  }else if(type === UpgradeType.MAX_DEPTH){
    var idx2 = gameData.maxDepthIndex;
    if(idx2 >= maxDepthUpgradeSteps.length-1) return;
    var next2 = maxDepthUpgradeSteps[idx2+1];
    if(gameData.coins >= next2.cost){
      gameData.coins -= next2.cost;
      gameData.maxDepthIndex++;
      updateCoinDisplay(gameData.coins);
      updateUpgradeButtons();
    }
  }
}

/* HUB */
function enterHub(){
  gameplaySubState = GameplaySubState.HUB;
  gaugeState.active = false;
  showCoinCounter();
  hideFishCounter();
  catchingEnabled = true;
  hookState.depthCurrent = 0;
  setHookDepth(0);
  layoutFishField();
  updateUpgradeButtons();
}

/* DESCENT */
function startDescent(selectedDepth){
  hookState.depthTarget = selectedDepth;
  hookState.depthCurrent = 0;
  hookState.caughtFishCount = 0;
  hookState.fishOnLine.length = 0;
  catchingEnabled = true;
  showFishCounter();
  hideCoinCounter();
  setFishCounter(0, hookState.maxFishThisRound());
  gameplaySubState = GameplaySubState.DESCENT;
  timers.stateStartTime = performance.now();
}

function updateDescent(dt){
  hookState.depthCurrent = Math.min(hookState.depthTarget, hookState.depthCurrent + hookState.speedDown*dt);
  setHookDepth(hookState.depthCurrent);
  updateCameraFollow();

  if(hookState.depthCurrent >= hookState.depthTarget - 0.05){
    enterAtDepthPause();
  }
}

/* AT DEPTH */
function enterAtDepthPause(){
  gameplaySubState = GameplaySubState.AT_DEPTH_PAUSE;
  var isFirstRound = gameData.roundIndex === 0;
  timers.atDepthDuration = isFirstRound ? 1.8 : 0.7;
  timers.stateStartTime = performance.now();
  if(isFirstRound){
    showTutorial();
  }
}

function updateAtDepthPause(){
  var elapsed = (performance.now() - timers.stateStartTime)/1000;
  if(elapsed >= timers.atDepthDuration){
    if(gameData.roundIndex === 0){
      hideTutorial();
    }
    startAscent();
  }
}

/* ASCENT */
function startAscent(){
  gameplaySubState = GameplaySubState.ASCENT;
  hookState.speedUp = 11;
}

function updateAscent(dt){
  hookState.depthCurrent = Math.max(0, hookState.depthCurrent - hookState.speedUp*dt);
  setHookDepth(hookState.depthCurrent);
  updateCameraFollow();

  handleFishCollisions();

  if(hookState.caughtFishCount >= hookState.maxFishThisRound()){
    hookState.speedUp = 24;
    catchingEnabled = false;
  }

  if(hookState.depthCurrent <= 0.15){
    preSurfaceSwapCounters();
    enterSurfaceSummary();
  }
}

/* SURFACE SUMMARY */
function preSurfaceSwapCounters(){
  hideFishCounter();
  showCoinCounter();
}

function enterSurfaceSummary(){
  gameplaySubState = GameplaySubState.SURFACE_SUMMARY;
  snapCameraToSurface();
  catchingEnabled = false;
  var gain = 0;
  for(var i=0;i<gameData.currentRoundCatch.length;i++){
    gain += gameData.currentRoundCatch[i].value;
  }
  gameData.coins += gain;
  gameData.totalEarned += gain;
  updateCoinDisplay(gameData.coins);
  showSummary(gain);
}

function updateSurfaceSummary(){}

/* ROUND TRANSITION / END */
function finishRound(){
  gameData.currentRoundCatch.length = 0;
  gameData.roundIndex++;
  if(gameData.roundIndex >= MAX_ROUNDS){
    enterEndcard();
  }else{
    enterHub();
  }
}

function enterEndcard(){
  currentState = GameState.ENDCARD;
  hideSummary();
  showEndCard();
}

/* ---------- HOOK & CAMERA ---------- */
function setHookDepth(depthMeters){
  var y = -depthMeters;
  hookMesh.position.y = y;
  lineMesh.position.y = (y + 0.8)/2;
  var lineLength = (0.8 - y);
  lineMesh.scale.y = lineLength/10;
}

function moveHookHorizontally(dx){
  hookMesh.position.x += dx;
  hookMesh.position.x = Math.max(-5.5, Math.min(5.5, hookMesh.position.x));
  lineMesh.position.x = hookMesh.position.x;
}

function getHookPosition(){
  return hookMesh.position;
}

function updateCameraFollow(){
  var targetY = hookMesh.position.y + 2.5;
  targetY = Math.min(1.5, targetY);
  camera.position.y += (targetY - camera.position.y)*0.08;
  camera.lookAt(0,camera.position.y-4,0);
}

function snapCameraToSurface(){
  camera.position.y = 0.2;
  camera.lookAt(0,-4,0);
}

/* ---------- FISH COLLISION ---------- */
function handleFishCollisions(){
  if(!catchingEnabled) return;
  if(hookState.caughtFishCount >= hookState.maxFishThisRound()) return;

  var hookPos = getHookPosition();
  for(var i=0;i<fishPool.length;i++){
    var fish = fishPool[i];
    if(fish.isCaught) continue;
    tmpVec3.copy(fish.position);
    var dx = tmpVec3.x - hookPos.x;
    var dy = tmpVec3.y - hookPos.y;
    var dz = tmpVec3.z - hookPos.z;
    var distSq = dx*dx+dy*dy+dz*dz;
    if(distSq < 0.4*0.4){
      catchFish(fish);
      if(hookState.caughtFishCount >= hookState.maxFishThisRound()){
        break;
      }
    }
  }
}

function catchFish(fish){
  fish.isCaught = true;
  fish.attachedToHook = true;
  hookState.caughtFishCount++;
  hookState.fishOnLine.push(fish);
  gameData.currentRoundCatch.push(fish);

  var offsetY = -0.4 - 0.4*(hookState.fishOnLine.length-1);
  fish.mesh.position.set(hookMesh.position.x, hookMesh.position.y+offsetY, hookMesh.position.z);
  fish.mesh.parent = hookMesh;

  setFishCounter(hookState.caughtFishCount, hookState.maxFishThisRound());

  if(fish.rarityIndex>0){
    showRarityLabel(rarityTexts[fish.rarityIndex] || "");
  }else{
    showRarityLabel("Nice!");
  }
  spawnCatchPopup("+"+fish.value);
}

function spawnCatchPopup(text){
  var el = document.createElement('div');
  el.className = 'catchPopup';
  el.textContent = text;
  document.getElementById('uiRoot').appendChild(el);
  var start = performance.now();
  var duration = 700;
  function anim(t){
    var dt = t - start;
    var r = dt/duration;
    if(r>1) r=1;
    var y = -20*r;
    var scale = 0.8 + 0.4*r;
    var opacity = r<0.7 ? r/0.7 : (1-r)/0.3;
    el.style.transform = "translate(-50%,"+( -50 + y )+"%) scale("+scale+")";
    el.style.opacity = opacity.toFixed(2);
    if(dt < duration){
      requestAnimationFrame(anim);
    }else{
      el.parentNode && el.parentNode.removeChild(el);
    }
  }
  requestAnimationFrame(anim);
}

/* ---------- MAIN LOOP ---------- */
function gameLoop(now){
  var dt = (now - timers.lastFrameTime)/1000;
  if(dt>0.1) dt=0.1;
  timers.lastFrameTime = now;

  update(dt, now);
  render();
  requestAnimationFrame(gameLoop);
}

function update(dt, now){
  if(timers.rarityLabelTimer>0){
    timers.rarityLabelTimer -= dt;
    if(timers.rarityLabelTimer<=0){
      hideRarityLabel();
    }
  }

  if(currentState === GameState.GAMEPLAY){
    if(gaugeState.active && gameplaySubState === GameplaySubState.GAUGE_ACTIVE){
      gaugeState.t += dt * gaugeState.speed;
      if(gaugeState.t>1) gaugeState.t -= 1;
      var t = gaugeState.t;
      var phase = t<0.5 ? (t*2) : (1 - (t-0.5)*2);
      updateGaugePointer(phase);
    }

    switch(gameplaySubState){
      case GameplaySubState.DESCENT:
        updateDescent(dt);
        break;
      case GameplaySubState.AT_DEPTH_PAUSE:
        updateAtDepthPause(dt);
        break;
      case GameplaySubState.ASCENT:
        updateAscent(dt);
        break;
      case GameplaySubState.SURFACE_SUMMARY:
        updateSurfaceSummary(dt);
        break;
    }
  }

  animateFisherman(now/1000);
  animateFish(now/1000);
}

function render(){
  renderer.render(scene, camera);
}

/* ---------- ANIMATIONS ---------- */
function animateFisherman(time){
  if(!fishermanGroup) return;
  fishermanGroup.rotation.z = Math.sin(time*0.8)*0.05;
  boatGroup.position.y = Math.sin(time*0.9)*0.12;
}

function animateFish(time){
  for(var i=0;i<fishPool.length;i++){
    var fish = fishPool[i];
    if(fish.attachedToHook){
      fish.mesh.rotation.y = Math.sin(time*4 + i)*0.3;
      continue;
    }
    var base = fish.position;
    var bob = Math.sin(time*1.1 + i)*0.08;
    var sway = Math.sin(time*1.6 + i*0.3)*0.05;
    fish.mesh.position.set(base.x + sway, base.y + bob, base.z);
    fish.mesh.rotation.y = Math.sin(time*1.6 + i)*0.6 + Math.PI;
  }
}

/* ---------- RESIZE ---------- */
function onResize(){
  var w = window.innerWidth;
  var h = window.innerHeight;
  renderer.setSize(w,h,false);
  camera.aspect = w/h;
  camera.updateProjectionMatrix();
}

/* ---------- SUMMARY NEXT (HOOK) ---------- */
summaryNextBtn.addEventListener('click', function(){
  finishRound();
});

/* ---------- START ---------- */
init();

})();
</script>
</body>
</html>